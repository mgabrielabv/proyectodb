<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Consultas de Cartas Magic</title>
  <link rel="stylesheet" href="proyectodb-master/css/consultas.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
</head>
<body>
  <header class="app-header">
    <h1>Consultas de Cartas Magic</h1>
    <button id="logoutBtn" class="logout-btn">
      <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
    </button>
  </header>

  <div class="query-container">
    <section>
      <h2>Cartas por Colección</h2>
      <div class="input-group">
        <label for="coleccionNombre">Nombre de colección:</label>
        <input type="text" id="coleccionNombre" placeholder="Ej: Revolución de Kamigawa" />
      </div>
      <button onclick="consultarCartasPorColeccion()">
        <i class="fas fa-search"></i> Consultar
      </button>
      <pre id="cartasResultado"></pre>
    </section>

    <section>
      <h2>Colecciones por Carta</h2>
      <div class="input-group">
        <label for="cartaNombre">Nombre de carta:</label>
        <input type="text" id="cartaNombre" placeholder="Ej: Dragón de Eiganjo" />
      </div>
      <button onclick="consultarColeccionesPorCarta()">
        <i class="fas fa-search"></i> Consultar
      </button>
      <pre id="coleccionesResultado"></pre>
    </section>
    <section>
      <h2>Categorías de Cartas por Colección</h2>
      <div class="input-group">
        <label for="coleccionNombreCategorias">Nombre de colección:</label>
        <input type="text" id="coleccionNombreCategorias" placeholder="Ej: Core Set 2021" />
      </div>
      <button onclick="consultarCategoriasCartas()">
        <i class="fas fa-search"></i> Consultar
      </button>
      <pre id="categoriasCartasResultado"></pre>
    </section>
    <section>
      <h2>Historial de Transacciones del Usuario</h2>
      <div class="input-group">
        <label for="usernameHistorial">Nombre de usuario:</label>
        <input type="text" id="usernameHistorial" placeholder="Ej: elProf" />
      </div>
      <button onclick="consultarHistorialUsuario()">
        <i class="fas fa-search"></i> Consultar
      </button>
      <div id="historialResultado" class="resultado-tabla"></div>
    </section>
    <section>
      <h2>Categorías por Colección</h2>
      <div class="input-group">
        <label for="coleccionNombreCat">Nombre de colección:</label>
        <input type="text" id="coleccionNombreCat" placeholder="Ej: Revolución de Kamigawa" />
      </div>
      <button onclick="consultarCategorias()">
        <i class="fas fa-search"></i> Consultar
      </button>
      <pre id="categoriasResultado"></pre>
    </section>

    <section>
      <h2>Cartas por Combinación de Colores y Fecha</h2>
      <div class="input-group">
        <label for="colorCombinacion">Combinación de colores:</label>
        <select id="colorCombinacion">
          <option value="">Selecciona una combinación</option>
          <option value="blanco">Mono Blanco (Monocolor)</option>
          <option value="azul">Mono Azul (Monocolor)</option>
          <option value="negro">Mono Negro (Monocolor)</option>
          <option value="rojo">Mono Rojo (Monocolor)</option>
          <option value="verde">Mono Verde (Monocolor)</option>
          <option value="blanco/azul">Azorius (Blanco/Azul)</option>
          <option value="azul/negro">Dimir (Azul/Negro)</option>
          <option value="negro/rojo">Rakdos (Negro/Rojo)</option>
          <option value="rojo/verde">Gruul (Rojo/Verde)</option>
          <option value="verde/blanco">Selesnya (Verde/Blanco)</option>
          <option value="blanco/negro">Orzhov (Blanco/Negro)</option>
          <option value="azul/rojo">Izzet (Azul/Rojo)</option>
          <option value="negro/verde">Golgari (Negro/Verde)</option>
          <option value="rojo/blanco">Boros (Rojo/Blanco)</option>
          <option value="verde/azul">Simic (Verde/Azul)</option>
          <option value="blanco/azul/negro">Esper (Blanco/Azul/Negro)</option>
          <option value="azul/negro/rojo">Grixis (Azul/Negro/Rojo)</option>
          <option value="negro/rojo/verde">Jund (Negro/Rojo/Verde)</option>
          <option value="rojo/verde/blanco">Naya (Rojo/Verde/Blanco)</option>
          <option value="verde/blanco/azul">Bant (Verde/Blanco/Azul)</option>
          <option value="blanco/negro/rojo">Mardu (Blanco/Negro/Rojo)</option>
          <option value="azul/rojo/verde">Temur (Azul/Rojo/Verde)</option>
          <option value="negro/verde/blanco">Abzan (Negro/Verde/Blanco)</option>
          <option value="rojo/blanco/azul">Jeskai (Rojo/Blanco/Azul)</option>
          <option value="verde/azul/negro">Sultai (Verde/Azul/Negro)</option>
          <option value="blanco/azul/negro/rojo">Yore-Tiller (Blanco/Azul/Negro/Rojo)</option>
          <option value="azul/negro/rojo/verde">Glint-Eye (Azul/Negro/Rojo/Verde)</option>
          <option value="negro/rojo/verde/blanco">Dune-Brood (Negro/Rojo/Verde/Blanco)</option>
          <option value="rojo/verde/blanco/azul">Ink-Treader (Rojo/Verde/Blanco/Azul)</option>
          <option value="verde/blanco/azul/negro">Witch-Maw (Verde/Blanco/Azul/Negro)</option>
          <option value="blanco/azul/negro/rojo/verde">Arcano (5 colores)</option>
        </select>
      </div>
      <div class="input-group">
        <label for="fechaInicioCombinacion">Fecha inicio:</label>
        <input type="date" id="fechaInicioCombinacion" />
      </div>
      <div class="input-group">
        <label for="fechaFinCombinacion">Fecha fin:</label>
        <input type="date" id="fechaFinCombinacion" />
      </div>
      <div class="input-group">
        <label for="multicolorCombinacion">Filtrar multicolor:</label>
        <select id="multicolorCombinacion">
          <option value="all">Mostrar todos</option>
          <option value="true">Solo multicolor</option>
          <option value="false">Excluir multicolor</option>
        </select>
      </div>
      <button onclick="consultarPorCombinacionColorYFecha()">
        <i class="fas fa-search"></i> Consultar
      </button>
      <pre id="combinacionColorResultado"></pre>
    </section>

    <section>
      <h2>Información de Mazo</h2>
      <div class="input-group">
        <label for="username">Nombre de usuario:</label>
        <input type="text" id="username" placeholder="Ej: mago123" />
      </div>
      <div class="input-group">
        <label for="mazoNombre">Nombre del mazo:</label>
        <input type="text" id="mazoNombre" placeholder="Ej: Control Azul" />
      </div>
      <button onclick="consultarMazoInfo()">
        <i class="fas fa-search"></i> Consultar
      </button>
      <pre id="mazoResultado"></pre>
    </section>
  
    <section>
      <h2>Ofertas y Estadísticas de Usuario</h2>
      <div class="input-group">
        <label for="usernameOfertas">Nombre de usuario:</label>
        <input type="text" id="usernameOfertas" placeholder="Ej: mago123" />
      </div>
      <button onclick="consultarOfertasUsuario()">
        <i class="fas fa-search"></i> Consultar
      </button>
      <pre id="ofertasResultado"></pre>
    </section>
  </div>

  <script>
    const BASE_URL = "http://localhost:4000";

    function mostrarError(elementoId, mensaje) {
      const elemento = document.getElementById(elementoId);
      elemento.innerHTML = `<div class="error">${mensaje}</div>`;
      elemento.style.display = 'block';
    }

    function mostrarResultado(elementoId, data) {
      const elemento = document.getElementById(elementoId);
      elemento.textContent = JSON.stringify(data, null, 2);
      elemento.style.display = 'block';
    }

    function toggleLoading(button, show) {
      if (show) {
        button.innerHTML = `<span class="loading"></span> Procesando...`;
        button.disabled = true;
      } else {
        const icon = button.getAttribute('data-icon') || '<i class="fas fa-search"></i>';
        button.innerHTML = `${icon} Consultar`;
        button.disabled = false;
      }
    }

    function formatToEnglishDate(dateString) {
      if (!dateString) return '';
      const date = new Date(dateString);
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    async function consultarCartasPorColeccion() {
      const nombre = document.getElementById("coleccionNombre").value.trim();
      const button = document.querySelector("button[onclick='consultarCartasPorColeccion()']");
      
      if (!nombre) {
        mostrarError("cartasResultado", "Por favor, ingresa un nombre de colección válido.");
        return;
      }

      try {
        toggleLoading(button, true);
        const response = await fetch(`${BASE_URL}/cartas/coleccion?coleccionNombre=${encodeURIComponent(nombre)}`);
        
        if (!response.ok) {
          const contentType = response.headers.get("content-type");
          if (contentType && contentType.includes("text/html")) {
            throw new Error("El servidor devolvió una página HTML en lugar de JSON. Verifica el backend.");
          }
          const errorData = await response.json();
          throw new Error(errorData.error || 'Error al obtener las cartas');
        }

        const data = await response.json();
        mostrarResultado("cartasResultado", data);
      } catch (error) {
        console.error("Error:", error);
        mostrarError("cartasResultado", `Error: ${error.message}`);
      } finally {
        toggleLoading(button, false);
      }
    }

    async function consultarColeccionesPorCarta() {
      const nombre = document.getElementById("cartaNombre").value.trim();
      const button = document.querySelector("button[onclick='consultarColeccionesPorCarta()']");

      if (!nombre) {
        mostrarError("coleccionesResultado", "Por favor, ingresa un nombre de carta válido.");
        return;
      }

      try {
        toggleLoading(button, true);
        const response = await fetch(`${BASE_URL}/colecciones/por-carta?cartaNombre=${encodeURIComponent(nombre)}`);
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'Error al obtener las colecciones');
        }

        const data = await response.json();
        mostrarResultado("coleccionesResultado", data);
      } catch (error) {
        console.error("Error:", error);
        mostrarError("coleccionesResultado", `Error: ${error.message}`);
      } finally {
        toggleLoading(button, false);
      }
    }

    async function consultarCategorias() {
      const nombre = document.getElementById("coleccionNombreCat").value.trim();
      const button = document.querySelector("button[onclick='consultarCategorias()']");

      if (!nombre) {
        mostrarError("categoriasResultado", "Por favor, ingresa un nombre de colección válido.");
        return;
      }

      try {
        toggleLoading(button, true);
        const response = await fetch(`${BASE_URL}/colecciones/categorias?coleccionNombre=${encodeURIComponent(nombre)}`);
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'Error al obtener las categorías');
        }

        const data = await response.json();
        mostrarResultado("categoriasResultado", data);
      } catch (error) {
        console.error("Error:", error);
        mostrarError("categoriasResultado", `Error: ${error.message}`);
      } finally {
        toggleLoading(button, false);
      }
    }

    async function consultarPorCombinacionColorYFecha() {
      const color = document.getElementById("colorCombinacion").value;
      const fechaInicio = formatToEnglishDate(document.getElementById("fechaInicioCombinacion").value);
      const fechaFin = formatToEnglishDate(document.getElementById("fechaFinCombinacion").value);
      const multicolor = document.getElementById("multicolorCombinacion").value;
      const button = document.querySelector("button[onclick='consultarPorCombinacionColorYFecha()']");

      if (!color) {
        mostrarError("combinacionColorResultado", "Por favor, selecciona una combinación de colores.");
        return;
      }

      try {
        toggleLoading(button, true);
        let url = `${BASE_URL}/cartas/filtrarPorColorFecha?color=${color}`;
        if (fechaInicio) url += `&fechaInicio=${fechaInicio}`;
        if (fechaFin) url += `&fechaFin=${fechaFin}`;
        if (multicolor !== 'all') url += `&multicolor=${multicolor}`;

        const response = await fetch(url);
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'Error al obtener las cartas por combinación de colores');
        }

        const data = await response.json();
        mostrarResultado("combinacionColorResultado", data);
      } catch (error) {
        console.error("Error:", error);
        mostrarError("combinacionColorResultado", `Error: ${error.message}`);
      } finally {
        toggleLoading(button, false);
      }
    }

    async function consultarMazoInfo() {
      const username = document.getElementById("username").value.trim();
      const mazoNombre = document.getElementById("mazoNombre").value.trim();
      const button = document.querySelector("button[onclick='consultarMazoInfo()']");

      if (!username || !mazoNombre) {
        mostrarError("mazoResultado", "Por favor, ingresa tanto el nombre de usuario como el nombre del mazo.");
        return;
      }

      try {
        toggleLoading(button, true);
        const url = `${BASE_URL}/mazos/por-jugador?username=${encodeURIComponent(username)}&mazoNombre=${encodeURIComponent(mazoNombre)}`;
        const response = await fetch(url);
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'Error al obtener la información del mazo');
        }

        const data = await response.json();
        mostrarResultado("mazoResultado", data);
      } catch (error) {
        console.error("Error:", error);
        mostrarError("mazoResultado", `Error: ${error.message}`);
      } finally {
        toggleLoading(button, false);
      }
    }

    async function consultarOfertasUsuario() {
      const username = document.getElementById("usernameOfertas").value.trim();
      const button = document.querySelector("button[onclick='consultarOfertasUsuario()']");

      if (!username) {
        mostrarError("ofertasResultado", "Por favor, ingresa un nombre de usuario.");
        return;
      }

      try {
        toggleLoading(button, true);
        const response = await fetch(`${BASE_URL}/usuarios/ofertas-estadisticas?username=${encodeURIComponent(username)}`);
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'Error al obtener las ofertas del usuario');
        }

        const data = await response.json();
        mostrarResultado("ofertasResultado", data);
      } catch (error) {
        console.error("Error:", error);
        mostrarError("ofertasResultado", `Error: ${error.message}`);
      } finally {
        toggleLoading(button, false);
      }
    }

    async function cerrarSesion() {
      try {
        const response = await fetch(`${BASE_URL}/logout`, {
          method: 'POST',
          credentials: 'include',
          headers: {
            'Content-Type': 'application/json'
          }
        });

        if (response.ok) {
          window.location.href = 'login.html';
        } else {
          const errorData = await response.json();
          console.error('Error al cerrar sesión:', errorData.error);
          mostrarError("cartasResultado", 'Error al cerrar sesión. Intenta nuevamente.');
        }
      } catch (error) {
        console.error('Error al cerrar sesión:', error);
        mostrarError("cartasResultado", 'Error de conexión al cerrar sesión');
      }
    }

    document.addEventListener('DOMContentLoaded', function() {
      const logoutBtn = document.getElementById('logoutBtn');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', cerrarSesion);
      }

      document.querySelectorAll('button').forEach(button => {
        if (button.innerHTML.includes('fa-search')) {
          button.setAttribute('data-icon', button.innerHTML);
        }
      });

      console.log('Aplicación de consultas Magic cargada correctamente');
    });
  </script>
</body>
</html>